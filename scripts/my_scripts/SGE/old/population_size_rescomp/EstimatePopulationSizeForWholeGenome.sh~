#!/bin/bash

#Treat expanding unset parameters as error 
set -u
#Exit with status 1 if a command throws an error
set -e

if [ $# -le 4 ]
  then
    echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
    echo "Not enough arguments supplied. Execute as"
    echo "./EstimatePopulationSize [path_to_relate] [pop1] [pop2]"
    exit 1;
fi

PATH_TO_RELATE=$1
pop1=$2
pop2=$3
pop="${pop1}${pop2}"

first_chr=1
last_chr=1

mkdir -p result_${pop}
log="std.log"
cp -r $PATH_TO_RELATE/bin .

sample=$(ls * | grep -e ".sample")
N=$(( 2 * ($(cat $sample | wc -l) - 1) ))

Rscript get_samples.R $pop1 $pop2

############## prepare data ##############

qsub -N PrepareFiles \
  -t $first_chr-$last_chr \
  -v pop1=${pop1},pop2=${pop2},pop=${pop} \
  -wd ${PWD}/result/ \
  -o std.log \
  PrepareFiles.sh

############## Estimate Population Size

## for all chromosomes, do
qsub -hold_jid PrepareFiles \
  -N CoalescentRate \
  -t $first_chr-$last_chr \
  -v pop1=${pop1},pop2=${pop2},pop=${pop} \
  -wd ${PWD}/result/ \
  -o std.log \
  EstimateCoalescentRate.sh

## then do
qsub -hold_jid CoalescentRate \
  -N FinalizeCoalescentRate \
  -v pop1=${pop1},pop2=${pop2},pop=${pop} \
  -wd ${PWD}/result/ \
  -o std.log \
  FinalizeCoalescentRate.sh


############## ReEstimateBranchLengths ################

for i in `seq 1 1 3`
do

  ## for all chromosomes, do
  qsub -hold_jid FinalizeCoalescentRate \
    -N ReEstimateBranchLengths \
    -t $first_chr-$last_chr \
    -v pop1=${pop1},pop2=${pop2},pop=${pop} \
    -wd ${PWD}/result/ \
    -o std.log \
    ReEstimateBranchLengths.sh

  ## for all chromosomes, do
  qsub -hold_jid ReEstimateBranchLengths \
    -N CoalescentRate \
    -t $first_chr-$last_chr \
    -v pop1=${pop1},pop2=${pop2},pop=${pop} \
    -wd ${PWD}/result/ \
    -o std.log \
    EstimateCoalescentRate.sh

  ## then do
  qsub -hold_jid CoalescentRate \
    -N FinalizeCoalescentRate \
    -v pop1=${pop1},pop2=${pop2},pop=${pop},first_chr=$first_chr,last_chr=$last_chr \
    -wd ${PWD}/result/ \
    -o std.log \
    FinalizeCoalescentRate.sh

  Rscript ../plot_population_size.R ${pop}
  Rscript ../MutationRateOverTime.R ${pop}

done


